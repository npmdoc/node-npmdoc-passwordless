<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/florianheinemann/passwordless">passwordless (v1.1.2)</a>
</h1>
<h4>A node.js/express module for passwordless authentication</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.passwordless">module passwordless</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless">
            function <span class="apidocSignatureSpan">passwordless.</span>Passwordless
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">passwordless.</span>Passwordless.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">passwordless.</span>_deliveryMethods</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.passwordless.Passwordless">module passwordless.Passwordless</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.Passwordless">
            function <span class="apidocSignatureSpan">passwordless.</span>Passwordless
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.passwordless.Passwordless.prototype">module passwordless.Passwordless.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype._generateNumberToken">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_generateNumberToken
            <span class="apidocSignatureSpan">(max)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype._generateToken">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_generateToken
            <span class="apidocSignatureSpan">(randomBytes)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype._redirectWithSessionSave">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_redirectWithSessionSave
            <span class="apidocSignatureSpan">(req, res, next, target)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype._send401">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_send401
            <span class="apidocSignatureSpan">(res, authenticate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.acceptToken">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>acceptToken
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.addDelivery">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>addDelivery
            <span class="apidocSignatureSpan">(name, sendToken, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.init">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>init
            <span class="apidocSignatureSpan">(tokenStore, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.logout">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>logout
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.requestToken">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>requestToken
            <span class="apidocSignatureSpan">(getUserID, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.restricted">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>restricted
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.passwordless.Passwordless.prototype.sessionSupport">
            function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>sessionSupport
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.passwordless" id="apidoc.module.passwordless">module passwordless</a></h1>


    <h2>
        <a href="#apidoc.element.passwordless.Passwordless" id="apidoc.element.passwordless.Passwordless">
        function <span class="apidocSignatureSpan">passwordless.</span>Passwordless
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Passwordless() {
	this._tokenStore = undefined;
	this._userProperty = undefined;
	this._deliveryMethods = {};
	this._defaultDelivery = undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.passwordless.Passwordless" id="apidoc.module.passwordless.Passwordless">module passwordless.Passwordless</a></h1>


    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.Passwordless" id="apidoc.element.passwordless.Passwordless.Passwordless">
        function <span class="apidocSignatureSpan">passwordless.</span>Passwordless
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">function Passwordless() {
	this._tokenStore = undefined;
	this._userProperty = undefined;
	this._deliveryMethods = {};
	this._defaultDelivery = undefined;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.passwordless.Passwordless.prototype" id="apidoc.module.passwordless.Passwordless.prototype">module passwordless.Passwordless.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype._generateNumberToken" id="apidoc.element.passwordless.Passwordless.prototype._generateNumberToken">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_generateNumberToken
        <span class="apidocSignatureSpan">(max)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_generateNumberToken = function (max) {
	var buf = crypto.randomBytes(4);
	return Math.floor(buf.readUInt32BE(0)%max).toString();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		getUserID(user, delivery, function(uidError, uid) {
			if(uidError) {
				next(new Error('Error on the user verification layer: ' + uidError));
			} else if(uid) {
				var token;
				try {
					if(deliveryMethod.options.numberToken &amp;&amp; deliveryMethod.options.numberToken.max) {
						token = self.<span class="apidocCodeKeywordSpan">_generateNumberToken</span>(deliveryMethod.options.numberToken.max);
					} else {
						token = (deliveryMethod.options.tokenAlgorithm || self._generateToken())();
					}
				} catch(err) {
					next(new Error('Error while generating a token: ' + err));
				}
				var ttl = deliveryMethod.options.ttl || 60 * 60 * 1000;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype._generateToken" id="apidoc.element.passwordless.Passwordless.prototype._generateToken">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_generateToken
        <span class="apidocSignatureSpan">(randomBytes)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_generateToken = function (randomBytes) {
	randomBytes = randomBytes || 16;
	return function() {
		var buf = crypto.randomBytes(randomBytes);
		return base58.encode(buf);
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				next(new Error('Error on the user verification layer: ' + uidError));
			} else if(uid) {
				var token;
				try {
					if(deliveryMethod.options.numberToken &amp;&amp; deliveryMethod.options.numberToken.max) {
						token = self._generateNumberToken(deliveryMethod.options.numberToken.max);
					} else {
						token = (deliveryMethod.options.tokenAlgorithm || self.<span class="apidocCodeKeywordSpan">_generateToken</span>())();
					}
				} catch(err) {
					next(new Error('Error while generating a token: ' + err));
				}
				var ttl = deliveryMethod.options.ttl || 60 * 60 * 1000;

				self._tokenStore.storeOrUpdate(token, uid.toString(), ttl, origin, function(storeError) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype._redirectWithSessionSave" id="apidoc.element.passwordless.Passwordless.prototype._redirectWithSessionSave">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_redirectWithSessionSave
        <span class="apidocSignatureSpan">(req, res, next, target)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_redirectWithSessionSave = function (req, res, next, target) {
	if (!req.session || this._skipForceSessionSave) {
		return res.redirect(target);
	} else {
		req.session.save(function(err) {
			if (err) {
				return next(err);
			} else {
				res.redirect(target);
			}
		});
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
							req.session.passwordless = req[self._userProperty];
						}
						if(options.successFlash) {
							req.flash('passwordless-success', options.successFlash);
						}
						if(options.enableOriginRedirect &amp;&amp; referrer) {
							// next() will not be called
							return self.<span class="apidocCodeKeywordSpan">_redirectWithSessionSave</span>(req, res, next, referrer);
						}
						if(options.successRedirect) {
							// next() will not be called, and
							// enableOriginRedirect has priority
							return self._redirectWithSessionSave(req, res, next, options.successRedirect);
						}
						next();
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype._send401" id="apidoc.element.passwordless.Passwordless.prototype._send401">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>_send401
        <span class="apidocSignatureSpan">(res, authenticate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_send401 = function (res, authenticate) {
	res.statusCode = 401;
	if(authenticate) {
		res.setHeader('WWW-Authenticate', authenticate);
	}
	res.end('Unauthorized');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...

			self._redirectWithSessionSave(req, res, next, options.failureRedirect + queryParam);
		} else if(options.failureFlash) {
			throw new Error('failureFlash cannot be used without failureRedirect');
		} else if(options.originField) {
			throw new Error('originField cannot be used without failureRedirect');
		} else {
			self.<span class="apidocCodeKeywordSpan">_send401</span>(res, 'Provide a token');
 		}
	}
}

/**
* Logs out the current user and invalidates any tokens that are still valid for the user
*
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.acceptToken" id="apidoc.element.passwordless.Passwordless.prototype.acceptToken">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>acceptToken
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">acceptToken = function (options) {
	var self = this;
	options = options || {};
	return function(req, res, next) {
		if(!self._tokenStore) {
			throw new Error('Passwordless is missing a TokenStore. Are you sure you called passwordless.init()?');
		}

		var tokenField = (options.tokenField) ? options.tokenField : 'token';
		var uidField = (options.uidField) ? options.uidField : 'uid';

		var token = req.query[tokenField], uid = req.query[uidField];
		if(!token &amp;&amp; !uid &amp;&amp; options.allowPost) {
			if(!req.body) {
				throw new Error('req.body does not exist: did you require middleware to accept POST data (such as body-parser) before calling
 acceptToken?')
			} else if(req.body[tokenField] &amp;&amp; req.body[uidField]) {
				token = req.body[tokenField];
				uid = req.body[uidField];
			}
		}

		if((options.failureFlash || options.successFlash) &amp;&amp; !req.flash) {
			throw new Error('To use failureFlash, flash middleware is required such as connect-flash');
		}

		if(token &amp;&amp; uid) {
			self._tokenStore.authenticate(token, uid.toString(), function(error, valid, referrer) {
				if(valid) {
					var success = function() {

						req[self._userProperty] = uid;
						if(req.session) {
							req.session.passwordless = req[self._userProperty];
						}
						if(options.successFlash) {
							req.flash('passwordless-success', options.successFlash);
						}
						if(options.enableOriginRedirect &amp;&amp; referrer) {
							// next() will not be called
							return self._redirectWithSessionSave(req, res, next, referrer);
						}
						if(options.successRedirect) {
							// next() will not be called, and
							// enableOriginRedirect has priority
							return self._redirectWithSessionSave(req, res, next, options.successRedirect);
						}
						next();
					}

					// Invalidate token, except allowTokenReuse has been set
					if(!self._allowTokenReuse) {
						self._tokenStore.invalidateUser(uid, function(err) {
							if(err) {
								next('TokenStore.invalidateUser() error: ' + error);
							} else {
								success();
							}
						})
					} else {
						success();
					}
				} else if(error) {
					next('TokenStore.authenticate() error: ' + error);
				} else if(options.failureFlash) {
					req.flash('passwordless', options.failureFlash);
					next();
				} else {
					next();
				}
			});
		} else {
			next();
		}
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		});
});
```

### 6. Setup the middleware for express
```javascript
app.use(passwordless.sessionSupport());
app.use(passwordless.<span class="apidocCodeKeywordSpan">acceptToken</span>({ successRedirect: '/'}));
```

`sessionSupport()` makes the login persistent, so the user will stay logged in while browsing your site. Make sure to have added
 your session middleware *before* this line. Have a look at [express-session](https://github.com/expressjs/session) how to setup
 sessions if you are unsure. Please be aware: If you decide to use [cookie-session](https://github.com/expressjs/cookie-session)
rather than e.g. express-session as your middleware you have to set `passwordless.init(tokenStore, {skipForceSessionSave:true})`

`acceptToken()` will accept incoming tokens and authenticate the user (see the URL in step 5). While the option `successRedirect
` is not strictly needed, it is strongly recommended to use it to avoid leaking valid tokens via the referrer header of outgoing
 HTTP links. When provided, the user will be forwarded to the given URL as soon as she has been authenticated.

Instead of accepting tokens on any URL as done above you can also restrict the acceptance of tokens to certain URLs:
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.addDelivery" id="apidoc.element.passwordless.Passwordless.prototype.addDelivery">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>addDelivery
        <span class="apidocSignatureSpan">(name, sendToken, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">addDelivery = function (name, sendToken, options) {
	// So that add can be called with (sendToken [, options])
	var defaultUsage = false;
	if(typeof name === 'function') {
		options = sendToken;
		sendToken = name;
		name = undefined;
		defaultUsage = true;
	}
	options = options || {};

	if(typeof sendToken !== 'function' || typeof options !== 'object'
		|| (name &amp;&amp; typeof name !== 'string')) {
		throw new Error('Passwordless.addDelivery called with wrong parameters');
	} else if((options.ttl &amp;&amp; typeof options.ttl !== 'number') ||
		(options.tokenAlgorithm &amp;&amp; typeof options.tokenAlgorithm !== 'function') ||
		(options.numberToken &amp;&amp; (!options.numberToken.max || typeof options.numberToken.max !== 'number'))) {
		throw new Error('One of the provided options is of the wrong format');
	} else if(options.tokenAlgorithm &amp;&amp; options.numberToken) {
		throw new Error('options.tokenAlgorithm cannot be used together with options.numberToken');
	} else if(this._defaultDelivery) {
		throw new Error('Only one default delivery method shall be defined and not be mixed up with named methods. Use named delivery
methods instead')
	} else if(defaultUsage &amp;&amp; Object.keys(this._deliveryMethods).length &gt; 0) {
		throw new Error('Default delivery methods and named delivery methods shall not be mixed up');
	}

	var method = {
			sendToken: sendToken,
			options: options
		};
	if(defaultUsage) {
		this._defaultDelivery = method;
	} else {
		if(this._deliveryMethods[name]) {
			throw new Error('Only one named delivery method with the same name shall be added')
		} else {
			this._deliveryMethods[name] = method;
		}
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
```javascript
// Your MongoDB TokenStore
var pathToMongoDb = 'mongodb://localhost/passwordless-simple-mail';
passwordless.init(new MongoStore(pathToMongoDb));
```

### 5. Tell Passwordless how to deliver a token
`passwordless.<span class="apidocCodeKeywordSpan">addDelivery</span>(deliver)` adds a new delivery mechanism. `deliver` is called
 whenever a token has to be sent. By default, the mechanism you choose should provide the user with a link in the following format
:

`http://www.example.com/?token={TOKEN}&amp;uid={UID}`

That's how you could do this with emailjs:
```javascript
// Set up a delivery service
passwordless.addDelivery(
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.init" id="apidoc.element.passwordless.Passwordless.prototype.init">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>init
        <span class="apidocSignatureSpan">(tokenStore, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">init = function (tokenStore, options) {
	options = options || {};
	if(!tokenStore) {
		throw new Error('tokenStore has to be provided')
	}

	this._tokenStore = tokenStore;
	this._userProperty = (options.userProperty) ? options.userProperty : 'user';
	this._allowTokenReuse = options.allowTokenReuse;
	this._skipForceSessionSave = (options.skipForceSessionSave) ? true : false;
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
   password: yourPwd,
   host:    yourSmtp,
   ssl:     true
});
```

### 4. Initialize Passwordless
`passwordless.<span class="apidocCodeKeywordSpan">init</span>()` will take your TokenStore, which will store the generated tokens
 as shown below for a MongoStore:
```javascript
// Your MongoDB TokenStore
var pathToMongoDb = 'mongodb://localhost/passwordless-simple-mail';
passwordless.init(new MongoStore(pathToMongoDb));
```

### 5. Tell Passwordless how to deliver a token
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.logout" id="apidoc.element.passwordless.Passwordless.prototype.logout">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>logout
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">logout = function (options) {
	var self = this;
	return function(req, res, next) {
		if(req.session &amp;&amp; req.session.passwordless) {
			delete req.session.passwordless;
		}
		if(req[self._userProperty]) {
			self._tokenStore.invalidateUser(req[self._userProperty], function() {
				delete req[self._userProperty];
				if(options &amp;&amp; options.successFlash) {
					if(!req.flash) {
						return next('To use successFlash, flash middleware is requied such as connect-flash');
					} else {
						req.flash('passwordless-success', options.successFlash);
					}
				}
				next();
			});
		} else {
			next();
		}
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		next();
	}
})
```

## Common options
### Logout
Just call `passwordless.<span class="apidocCodeKeywordSpan">logout</span>()` as in:
```javascript
router.get('/logout', passwordless.logout(),
	function(req, res) {
		res.redirect('/');
});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.requestToken" id="apidoc.element.passwordless.Passwordless.prototype.requestToken">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>requestToken
        <span class="apidocSignatureSpan">(getUserID, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">requestToken = function (getUserID, options) {
	var self = this;
	options = options || {};
	
	return function(req, res, next) {
		var sendError = function(statusCode, authenticate) {
			if(options.failureRedirect) {
				if(options.failureFlash) {
					req.flash('passwordless', options.failureFlash);
				}
				self._redirectWithSessionSave(req, res, next, options.failureRedirect);
			} else {
				if(statusCode === 401) {
					self._send401(res, authenticate)
				} else {
					res.status(statusCode).send();
				}
			}
		}

		if(!self._tokenStore) {
			throw new Error('Passwordless is missing a TokenStore. Are you sure you called passwordless.init()?');
		}

		if(!req.body &amp;&amp; !options.allowGet) {
			throw new Error('req.body does not exist: did you require middleware to accept POST data (such as body-parser) before calling
 acceptToken?')
		} else if(!self._defaultDelivery &amp;&amp; Object.keys(self._deliveryMethods).length === 0) {
			throw new Error('passwordless requires at least one delivery method which can be added using passwordless.addDelivery()');
		} else if((options.successFlash || options.failureFlash) &amp;&amp; !req.flash) {
			throw new Error('To use failureFlash or successFlash, flash middleware is required such as connect-flash');
		} else if(options.failureFlash &amp;&amp; !options.failureRedirect) {
			throw new Error('failureFlash cannot be used without failureRedirect');
		}

		var userField = (options.userField) ? options.userField : 'user';
		var deliveryField = (options.deliveryField) ? options.deliveryField : 'delivery';
		var originField = (options.originField) ? options.originField : null;

		var user, delivery, origin;
		if(req.body &amp;&amp; req.method === "POST") {
			user = req.body[userField];
			delivery = req.body[deliveryField];
			if(originField) {
				origin = req.body[originField];
			}
		} else if(options.allowGet &amp;&amp; req.method === "GET") {
			user = req.query[userField];
			delivery = req.query[deliveryField];
			if(originField) {
				origin = req.query[originField];
			}
		}

		var deliveryMethod = self._defaultDelivery;
		if(delivery &amp;&amp; self._deliveryMethods[delivery]) {
			deliveryMethod = self._deliveryMethods[delivery];
		}

		if(typeof user === 'string' &amp;&amp; user.length === 0) {
			return sendError(401, 'Provide a valid user');
		} else if(!deliveryMethod || !user) {
			return sendError(400);
		}

		getUserID(user, delivery, function(uidError, uid) {
			if(uidError) {
				next(new Error('Error on the user verification layer: ' + uidError));
			} else if(uid) {
				var token;
				try {
					if(deliveryMethod.options.numberToken &amp;&amp; deliveryMethod.options.numberToken.max) {
						token = self._generateNumberToken(deliveryMethod.options.numberToken.max);
					} else {
						token = (deliveryMethod.options.tokenAlgorithm || self._generateToken())();
					}
				} catch(err) {
					next(new Error('Error while generating a token: ' + err));
				}
				var ttl = deliveryMethod.options.ttl || 60 * 60 * 1000;

				self._tokenStore.storeOrUpdate(token, uid.toString(), ttl, origin, function(storeError) {
					if(storeError) {
						next(new Error('Error on the storage layer: ' + storeError));
					} else {
						deliveryMethod.sendToken(token, uid, user, function(deliveryError) {
							if(deliveryError) {
								next(new Error('Error on the deliveryMethod delivery layer: ' + deliveryError));
							} else {
								if(!req.passwordless) {
									req.passwordless = {};
								}
								req.passwordless.uidToAuth = uid;
								if(options.successFlash) {
									req.flash('passwordless-success', options.successFlash);
								}
								next();
							}
						}, req)		
					}	
				});
			} else {
				sendError(401, 'Provide a valid user');
			}
		}, req)
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
/* GET login screen. */
router.get('/login', function(req, res) {
   res.render('login');
});

/* POST login details. */
router.post('/sendtoken',
	passwordless.<span class="apidocCodeKeywordSpan">requestToken</span>(
		// Turn the email address into an user's ID
		function(user, delivery, callback, req) {
			// usually you would want something like:
			User.find({email: user}, callback(ret) {
			   if(ret)
			      callback(null, ret.id)
			   else
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.restricted" id="apidoc.element.passwordless.Passwordless.prototype.restricted">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>restricted
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">restricted = function (options) {
	var self = this;
	return function(req, res, next) {
		if(req[self._userProperty]) {
			return next();
		}

		// not authorized
		options = options || {};
		if(options.failureRedirect) {
			var queryParam = '';
			if(options.originField){
				var parsedRedirectUrl = url.parse(options.failureRedirect), queryParam = '?';
				if(parsedRedirectUrl.query) {
					queryParam = '&amp;';
				}
				queryParam += options.originField + '=' + encodeURIComponent(req.originalUrl);
			}

			if(options.failureFlash) {
				if(!req.flash) {
					throw new Error('To use failureFlash, flash middleware is requied such as connect-flash');
				} else {
					req.flash('passwordless', options.failureFlash);
				}
			}	

			self._redirectWithSessionSave(req, res, next, options.failureRedirect + queryParam);
		} else if(options.failureFlash) {
			throw new Error('failureFlash cannot be used without failureRedirect');
		} else if(options.originField) {
			throw new Error('originField cannot be used without failureRedirect');
		} else {
			self._send401(res, 'Provide a token');
  		}
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		&lt;/form&gt;
	&lt;/body&gt;
&lt;/html&gt;
```
By default, Passwordless will look for a field called `user` submitted via POST.

### 9. Protect your pages
You can protect all pages that should only be accessed by authenticated users by using the `passwordless.<span class="apidocCodeKeywordSpan
">restricted</span>()` middleware, for example:
```javascript
/* GET restricted site. */
router.get('/restricted', passwordless.restricted(),
 function(req, res) {
  // render the secret page
});
```
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.passwordless.Passwordless.prototype.sessionSupport" id="apidoc.element.passwordless.Passwordless.prototype.sessionSupport">
        function <span class="apidocSignatureSpan">passwordless.Passwordless.prototype.</span>sessionSupport
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">sessionSupport = function () {
	var self = this;
	return function(req, res, next) {
		if(!req.session) {
			throw new Error('sessionSupport requires session middleware such as expressSession');
		} else if (req.session.passwordless) {
			req[self._userProperty] = req.session.passwordless;
		}
		next();
	}
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			callback(err);
		});
});
```

### 6. Setup the middleware for express
```javascript
app.use(passwordless.<span class="apidocCodeKeywordSpan">sessionSupport</span>());
app.use(passwordless.acceptToken({ successRedirect: '/'}));
```

`sessionSupport()` makes the login persistent, so the user will stay logged in while browsing your site. Make sure to have added
 your session middleware *before* this line. Have a look at [express-session](https://github.com/expressjs/session) how to setup
 sessions if you are unsure. Please be aware: If you decide to use [cookie-session](https://github.com/expressjs/cookie-session)
rather than e.g. express-session as your middleware you have to set `passwordless.init(tokenStore, {skipForceSessionSave:true})`

`acceptToken()` will accept incoming tokens and authenticate the user (see the URL in step 5). While the option `successRedirect
` is not strictly needed, it is strongly recommended to use it to avoid leaking valid tokens via the referrer header of outgoing
 HTTP links. When provided, the user will be forwarded to the given URL as soon as she has been authenticated.
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>